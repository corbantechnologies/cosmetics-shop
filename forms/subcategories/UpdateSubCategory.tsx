"use client";

import React, { useState } from "react";
import { useFormik } from "formik";
import { updateSubCategory } from "@/services/subcategories";
import { useFetchCategoriesVendor } from "@/hooks/categories/actions";
import { useFetchSubCategory } from "@/hooks/subcategories/actions";
import useAxiosAuth from "@/hooks/authentication/useAxiosAuth";
import toast from "react-hot-toast";

export default function UpdateSubCategory({
  reference,
  onSuccess,
}: {
  reference: string;
  onSuccess?: () => void;
}) {
  const authHeaders = useAxiosAuth();
  const [loading, setLoading] = useState(false);

  const {
    data: subCategory,
    isLoading: subCategoryLoading,
    isError,
  } = useFetchSubCategory(reference);
  const { data: categories, isLoading: categoriesLoading } =
    useFetchCategoriesVendor();

  const formik = useFormik({
    initialValues: {
      name: subCategory?.name || "",
      category: subCategory?.category || "",
      is_active: subCategory?.is_active ?? true,
    },
    enableReinitialize: true,
    onSubmit: async (values) => {
      if (!values.category) {
        toast.error("Please select a category");
        return;
      }

      setLoading(true);
      try {
        await updateSubCategory(reference, values, authHeaders);
        toast.success("SubCategory updated successfully");
        if (onSuccess) onSuccess();
      } catch (error) {
        toast.error("Failed to update subcategory");
        console.error(error);
      } finally {
        setLoading(false);
      }
    },
  });

  if (subCategoryLoading)
    return <div className="p-4 text-center">Loading details...</div>;
  if (isError)
    return (
      <div className="p-4 text-center text-red-500">
        Error loading subcategory.
      </div>
    );

  return (
    <form onSubmit={formik.handleSubmit} className="space-y-6 w-full max-w-lg">
      <div>
        <label
          htmlFor="name"
          className="block text-sm font-medium text-foreground mb-1"
        >
          Name
        </label>
        <input
          id="name"
          name="name"
          type="text"
          required
          onChange={formik.handleChange}
          onBlur={formik.handleBlur}
          value={formik.values.name}
          className="w-full px-4 py-2 border border-secondary rounded-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary transition-colors"
        />
      </div>

      <div>
        <label
          htmlFor="category"
          className="block text-sm font-medium text-foreground mb-1"
        >
          Category
        </label>
        <select
          id="category"
          name="category"
          required
          onChange={formik.handleChange}
          onBlur={formik.handleBlur}
          value={formik.values.category}
          className="w-full px-4 py-2 border border-secondary rounded-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary transition-colors bg-white"
        >
          <option value="">Select a category</option>
          {categoriesLoading ? (
            <option disabled>Loading categories...</option>
          ) : (
            categories?.map((category) => (
              <option key={category.reference} value={category.name}>
                {category.name}
              </option>
            ))
          )}
        </select>
      </div>

      <div className="flex items-center space-x-2">
        <input
          id="is_active"
          name="is_active"
          type="checkbox"
          onChange={formik.handleChange}
          checked={formik.values.is_active}
          className="h-4 w-4 text-primary focus:ring-primary border-secondary rounded"
        />
        <label
          htmlFor="is_active"
          className="text-sm font-medium text-foreground cursor-pointer"
        >
          Is Active
        </label>
      </div>

      <button
        type="submit"
        disabled={loading}
        className="w-full py-2 px-4 bg-primary text-primary-foreground font-medium rounded-sm hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {loading ? "Updating..." : "Update SubCategory"}
      </button>
    </form>
  );
}
